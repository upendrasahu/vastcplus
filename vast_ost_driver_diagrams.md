# Vast Data OST Driver Architecture & Implementation Plan

## 1. High-Level OST Driver Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                    NetBackup Environment                        │
│                                                                 │
│  ┌─────────────────┐     ┌─────────────────────────────────────┐│
│  │  Master Server  │────▶│         Media Servers               ││
│  │  • Policy Mgmt  │     │  ┌─────────────────────────────────┐││
│  │  • Job Schedule │     │  │ Media Server 1                  │││
│  │  • Catalog DB   │     │  │ ┌─────────────────────────────┐ │││
│  │  • Admin UI     │     │  │ │    Vast Data OST Driver     │ │││
│  └─────────────────┘     │  │ │                             │ │││
│                          │  │ └─────────────────────────────┘ │││
│                          │  └─────────────────────────────────┘││
│                          │  ┌─────────────────────────────────┐││
│                          │  │ Media Server 2                  │││
│                          │  │ ┌─────────────────────────────┐ │││
│                          │  │ │    Vast Data OST Driver     │ │││
│                          │  │ │                             │ │││
│                          │  │ └─────────────────────────────┘ │││
│                          │  └─────────────────────────────────┘││
│                          └─────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
                                         │
                                    ┌─────────┐
                                    │ Network │
                                    └─────────┘
                                         │
┌─────────────────────────────────────────────────────────────────┐
│                  Vast Data Cluster                              │
│                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │    Node 1   │  │    Node 2   │  │    Node N   │              │
│  │             │  │             │  │             │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │            Global Namespace & API Layer                     ││
│  │  • Management APIs  • Data APIs  • S3 APIs                  ││
│  └─────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
```

## 2. Detailed OST Driver Internal Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                    Vast Data OST Driver                         │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                OST API Layer                                ││
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐            ││
│  │  │ stsp_init   │ │stsp_claim   │ │stsp_open_   │    ...     ││
│  │  │stsp_terminate│ │             │ │server       │           ││
│  │  └─────────────┘ └─────────────┘ └─────────────┘            ││
│  └─────────────────────────────────────────────────────────────┘│
│                               │                                 │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │              OST Operation Handlers                         ││
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐            ││
│  │  │   Server    │ │     LSU     │ │    Image    │            ││
│  │  │ Operations  │ │ Operations  │ │ Operations  │            ││
│  │  │             │ │             │ │             │            ││
│  │  └─────────────┘ └─────────────┘ └─────────────┘            ││
│  └─────────────────────────────────────────────────────────────┘│
│                               │                                 │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │             Multi-Threading Layer                           ││
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐            ││
│  │  │Thread Pool  │ │Connection   │ │Async I/O    │            ││
│  │  │Manager      │ │Pool Manager │ │Manager      │            ││
│  │  └─────────────┘ └─────────────┘ └─────────────┘            ││
│  └─────────────────────────────────────────────────────────────┘│
│                               │                                 │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │            Vast Data Client Library                         ││
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐            ││
│  │  │Management   │ │  Data I/O   │ │   Error     │            ││
│  │  │  Client     │ │   Client    │ │  Handler    │            ││
│  │  └─────────────┘ └─────────────┘ └─────────────┘            ││
│  └─────────────────────────────────────────────────────────────┘│
│                               │                                 │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │              Protocol & Network Layer                       ││
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐            ││
│  │  │ HTTP/REST   │ │    NFS      │ │ Custom TCP  │            ││
│  │  │   Client    │ │   Client    │ │   Client    │            ││
│  │  └─────────────┘ └─────────────┘ └─────────────┘            ││
│  └─────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
                                │
                          ┌─────────────┐
                          │   Network   │
                          └─────────────┘
                                │
┌─────────────────────────────────────────────────────────────────┐
│                     Vast Data APIs                              │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐    │
│  │ Management APIs │ │   Data APIs     │ │   S3 APIs       │    │
│  │ • Volume Mgmt   │ │ • File I/O      │ │ • Object Store  │    │
│  │ • User Mgmt     │ │ • Metadata      │ │ • Bucket Mgmt   │    │
│  │ • Monitoring    │ │ • Snapshots     │ │                 │    │
│  └─────────────────┘ └─────────────────┘ └─────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
```

## 3. OST Driver Data Flow Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                    Backup Data Flow                             │
│                                                                 │
│ NetBackup Client ──── Data Stream ────▶ Media Server            │
│                                              │                  │
│                                              ▼                  │
│                                    ┌─────────────────┐          │
│                                    │ OST Driver      │          │
│                                    │                 │          │
│  ┌─────────────────────────────────┼─────────────────┼─────────┐│
│  │            OST API              │                 │         ││
│  │                                 │                 │         ││
│  │ stsp_create_image() ────────────┼──── Image ──────┼────┐    ││
│  │ stsp_write_image()  ────────────┼──── Creation ───┼────┤    ││
│  │ stsp_close_image()  ────────────┼──── & Write ────┼────┤    ││
│  │                                 │                 │    │    ││
│  └─────────────────────────────────┼─────────────────┼────┼────┘│
│                                    │                 │    │     │
│                                    └─────────────────┘    │     │
│                                                           │     │
│                                                           ▼     │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                Stream Processing                            ││
│  │                                                             ││
│  │  Stream 1 ─────┐                                            ││
│  │  Stream 2 ─────┤                                            ││
│  │  Stream 3 ─────┼──── Buffer Pool ────┐                      ││
│  │  Stream 4 ─────┤                     │                      ││
│  │  Stream N ─────┘                     │                      ││
│  │                                      ▼                      ││
│  │                              ┌─────────────┐                ││
│  │                              │ Data        │                ││
│  │                              │ Aggregator  │                ││
│  │                              └─────────────┘                ││
│  └─────────────────────────────────────────────┼───────────────┘│
│                                                │                │
│                                                ▼                │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                 Vast Data Interface                         ││
│  │                                                             ││
│  │  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐      ││
│  │  │  Volume     │    │   File      │    │   Object    │      ││
│  │  │ Management  │    │   I/O       │    │   Store     │      ││
│  │  └─────────────┘    └─────────────┘    └─────────────┘      ││
│  └─────────────────────────────────────────┼───────────────────┘│
└────────────────────────────────────────────┼────────────────────┘
                                             │
                                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                   Vast Data Storage                             │
│                                                                 │
│  File: /backups/client1/20241201/image_001.nbk                  │
│  Metadata: LSU mapping, Image properties, NetBackup catalog     │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 4. OST Driver Component Design

### 4.1 Core Components

```
┌─────────────────────────────────────────────────────────────────┐
│                  OST Driver Components                          │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                Server Management                            ││
│  │                                                             ││
│  │  • stsp_open_server() / stsp_close_server()                 ││
│  │  • Server handle management                                 ││
│  │  • Connection lifecycle                                     ││
│  │  • Authentication & authorization                           ││
│  │  • Server properties reporting                              ││
│  │                                                             ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                LSU Management                               ││
│  │                                                             ││
│  │  • stsp_list_lsu() / stsp_open_lsu_list()                   ││
│  │  • LSU discovery and enumeration                            ││
│  │  • LSU properties and capabilities                          ││
│  │  • Storage capacity reporting                               ││
│  │  • LSU-to-Volume mapping                                    ││
│  │                                                             ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                Image Management                             ││
│  │                                                             ││
│  │  • stsp_create_image() / stsp_open_image()                  ││
│  │  • stsp_write_image() / stsp_read_image()                   ││
│  │  • stsp_close_image() / stsp_delete_image()                 ││
│  │  • Image metadata management                                ││
│  │  • Image lifecycle and retention                            ││
│  │                                                             ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │              Advanced Operations                            ││
│  │                                                             ││
│  │  • stsp_copy_image() - Image duplication                    ││
│  │  • stsp_async_operations() - Async I/O                      ││
│  │  • Multi-stream support                                     ││
│  │  • Error handling and recovery                              ││
│  │                                                             ││
│  └─────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 Threading and Concurrency Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│              Multi-Threading Architecture                       │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                  Main Thread                                ││
│  │                                                             ││
│  │  • OST API calls reception                                  ││
│  │  • Request validation                                       ││
│  │  • Thread pool dispatching                                  ││
│  │  • Response coordination                                    ││
│  │                                                             ││
│  └─────────────────────────┬───────────────────────────────────┘│
│                            │                                    │
│  ┌─────────────────────────▼───────────────────────────────────┐│
│  │                Thread Pool Manager                          ││
│  │                                                             ││
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐            ││
│  │  │ I/O Thread  │ │ I/O Thread  │ │ I/O Thread  │    ...     ││
│  │  │    Pool     │ │    Pool     │ │    Pool     │            ││
│  │  │   (1-16)    │ │   (1-16)    │ │   (1-16)    │            ││
│  │  └─────────────┘ └─────────────┘ └─────────────┘            ││
│  │                                                             ││
│  └─────────────────────────┬───────────────────────────────────┘│
│                            │                                    │
│  ┌─────────────────────────▼───────────────────────────────────┐│
│  │               Connection Pool Manager                       ││
│  │                                                             ││
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐            ││
│  │  │  HTTP/REST  │ │     NFS     │ │  Management │            ││
│  │  │ Connections │ │ Connections │ │ Connections │            ││
│  │  │   (Pool)    │ │   (Pool)    │ │   (Pool)    │            ││
│  │  └─────────────┘ └─────────────┘ └─────────────┘            ││
│  │                                                             ││
│  └─────────────────────────┬───────────────────────────────────┘│
│                            │                                    │
│  ┌─────────────────────────▼───────────────────────────────────┐│
│  │                 Vast Data Clients                           ││
│  │                                                             ││
│  │  • Concurrent API calls to Vast Data                        ││
│  │  • Load balancing across cluster nodes                      ││
│  │  • Automatic retry and failover                             ││
│  │  • Performance monitoring                                   ││
│  │                                                             ││
│  └─────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
```

